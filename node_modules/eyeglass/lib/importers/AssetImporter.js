"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var fs_1 = require("fs");
var URI_1 = require("../util/URI");
var ImportUtilities_1 = require("./ImportUtilities");
var EyeglassModules_1 = require("../modules/EyeglassModules");
var typescriptUtils_1 = require("../util/typescriptUtils");
// import pattern matches `assets` and `foo/assets`, but not `foo/bar/assets`
var rAssetsImport = /^(?:([^/]+)\/)?assets$/;
var AssetImporter = function (eyeglass, sass, options, fallbackImporter) {
    return ImportUtilities_1.default.createImporter(function (uri, prev, done) {
        var importUtils = new ImportUtilities_1.default(eyeglass, sass, options, fallbackImporter, this);
        var isRealFile = fs_1.existsSync(prev);
        var mod;
        function importAssetsFor(mod) {
            var contents;
            function getAssetImport() {
                // XXX what is the correct behavior for when mod.name isn't found?
                return mod.assets ? mod.assets.asAssetImport(mod.name) : "";
            }
            // allow build tools to specify a function to cache the imports
            if (typescriptUtils_1.isPresent(mod.assets) && typescriptUtils_1.isPresent(options.assetsCache)) {
                contents = options.assetsCache(mod.assets.cacheKey(mod.name || EyeglassModules_1.ROOT_NAME), getAssetImport);
            }
            else {
                contents = getAssetImport();
            }
            importUtils.importOnce({
                contents: contents,
                file: "autoGenerated:" + URI_1.URI.join(mod.name || EyeglassModules_1.ROOT_NAME, "assets")
            }, done);
        }
        var isRelativeImport = URI_1.URI.isRelative(uri);
        var assetsImport = !isRelativeImport && rAssetsImport.exec(uri);
        // the first fragment of the match is the module name
        var moduleName = assetsImport && assetsImport[1];
        // if it's not an assets import, or it's `eyeglass/assets`,
        //  just use the fallback importer
        if (!assetsImport) {
            importUtils.fallback(uri, prev, done, function () {
                done(null);
            });
        }
        else {
            // if the module name wasn't specified in the import,
            // infer it from the origin
            if (!moduleName && isRealFile) {
                mod = eyeglass.modules.findByPath(prev);
                // if it's an eyeglass module...
                if (mod && mod.isEyeglassModule) {
                    // use the module's name
                    moduleName = mod.name;
                }
            }
            // if we have a module name...
            if (moduleName) {
                // try to access the module
                mod = eyeglass.modules.access(moduleName, isRealFile ? prev : options.eyeglass.root);
                // if we can access it...
                if (mod) {
                    /* eslint max-depth:0 */
                    // if it has assets...
                    if (mod.assets) {
                        // import them
                        importAssetsFor(mod);
                    }
                    else {
                        // otherwise throw an error
                        done(new Error("No assets specified for eyeglass plugin " + mod.name));
                    }
                }
                else {
                    // if we can't find/access it, throw an error
                    done(new Error("No eyeglass plugin named: " + moduleName));
                }
            }
            else {
                // otherwise, import the app assets
                // TODO: Move app assets to the root module and pass the root eyeglass
                // module here
                importAssetsFor(eyeglass);
            }
        }
    });
};
exports.default = AssetImporter;
//# sourceMappingURL=AssetImporter.js.map